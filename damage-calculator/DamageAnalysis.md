# SAOIF傷害計算公式以及推導過程
* [基礎知識](#一基礎知識)
* [使用追加傷害推導部分傷害公式](#二使用追加傷害推導部分傷害公式)
* [控制攻擊力和倍率推導boss防禦影響](#三控制攻擊力和倍率推導boss防禦影響)
* [覺醒率影響](#四覺醒率影響)
* [混沌追憶作用](#五混沌追憶作用)
* [最終公式和結論](#六最終公式和結論)
## 一、基礎知識
基礎知識作爲游戲常識，在本文中不加以驗證

以下是部分基礎知識：

    追加傷害無視防禦，能夠受一系列傷害加成影響
    基礎爆擊傷害50%
    一般情況下基礎弱點傷害50%，除非有特殊説明（discord可查）
    面板顯示攻擊的為最大值。
    武器攻擊力在某個區間内有一定浮動（具體看武器强化界面）
## 二、使用追加傷害推導部分傷害公式
### 數據展示
面板

![2-1](imgs/2/2-1.png)

測試卡

![2-2](imgs/2/2-2.png)
### 關掉以下熟練度技能去除影響
![2-3](imgs/2/2-3.png)
![2-4](imgs/2/2-4.png)
### 測試boss
冥黑155灼射

    99%武器抗性
    50%斬弱
    50%暗弱

![2-5](imgs/2/2-5.png)

冥黑195牢城主

    50%傷害抗性
    40%爆擊抗性
    300%武器抗性
    50%刺弱
    50%暗弱
    150%其他屬性抗性

![2-6.png](imgs/2/2-6.png)
### 測試數據
以下為基礎數據，後續測試在此基礎上增加其他傷害加成

普通攻擊
![2-7.png](imgs/2/2-7.png)
技能
![2-8.png](imgs/2/2-8.png)
由於boss過高防禦影響，由攻擊和倍率產生的傷害被抵消，只剩下追加傷害生效。

傷害組成：

    追加傷害350
    强制扣血1
    斬弱50%

得出如下：

    (350+1)*(1+50%)=526.5
    526.5向下取整=>526

使用賦予

![2-9.png](imgs/2/2-9.png)

![2-10.png](imgs/2/2-10.png)

傷害組成：

    追加傷害350
    强制扣血1
    斬弱50%
    暗弱50%

得出如下：

    (350+1)*(1+50%+50%)=702

説明自然屬性弱點和武器屬性弱點在同一區間

使用爆擊

![2-11.png](imgs/2/2-11.png)

傷害組成：
    
    追加傷害350
    强制扣血1
    斬弱50%
    爆擊50%

得出如下：

    (350+1)*(1+50%+50%)=702

説明爆擊傷害和武器屬性弱點在同一區間

使用細劍+賦予

![2-12.png](imgs/2/2-12.png)

傷害組成：

    追加傷害350
    强制扣血1
    武器抗性99%
    暗弱50%

得出如下：

    (350+1)*(1+50%-99%)=179.01向下取整=>179

説明抗性和弱點爆傷等在同一區間且為綫性叠加關係(簡單相加減)

使用2倍刻印

![2-13.png](imgs/2/2-13.png)

這裏雖然顯示boss有一個盾的buff，其實傷害是在此buff出現前打出的所以不影響

![2-14.png](imgs/2/2-14.png)

傷害組成：

    追加傷害350
    强制扣血1
    斬弱50%
    刻印2倍

得出如下：

    (350+1)*(1+50%)*2=1053

推斷：

    在(350+1)*1.5=526.5后可能對傷害進行了向下取整操作
    (350+1)*1.5=526.5向下取整=>526
    562*2=1052

使用死兆印+刻印
![2-15.png](imgs/2/2-15.png)
![2-16.png](imgs/2/2-16.png)

傷害組成：

    追加傷害350
    强制扣血1
    斬弱50%
    死兆印1.1倍
    刻印2倍

得出如下：

    (350+1)*(1+50%)*(1+0.1+1)= 1105.65
    (350+1)*1.5=526.5向下取整=>526
    562*2.1=1104.6向下取整=>1104

得出死兆印刻印在同一區間且為綫性叠加關係

其他如小刻印，2.5倍刻印同樣在此區間就不一一測試了

攻擊90級混沌人馬50層免傷(傷害抗性)

![2-17.png](imgs/2/2-17.png)

雙克爆擊情況傷害為1

説明免傷為100%，因爲有一個乘區為0，所以其他乘區增傷再高也無效

使用刻印傷害正常，説明免傷在刻印區間且為綫性叠加關係

![2-18.png](imgs/2/2-18.png)

雙克攻擊牢城主

![2-19.png](imgs/2/2-19.png)

傷害組成：

    追加傷害350
    强制扣血1
    刺弱50%+10%
    暗弱50%
    傷害抗性50%

得出如下：
    
    (350+1)*(1+50%+10%+50%)*(1-50%)= 1,105.65
    (350+1)*2.1= 737.1向下取整=>737
    737*0.5=368.5向下取整=>368

雙克攻擊具有混沌追憶的牢城主

![2-20.png](imgs/2/2-20.png)

傷害組成：

    追加傷害350
    强制扣血1
    刺弱50%+10%
    暗弱50%
    傷害抗性50%
    混沌追憶免傷50%

得出如下：

    (350+1)*(1+50%+10%+50%)*(1-50%)= 1,105.65
    (350+1)*2.1= 737.1向下取整=>737
    737*0.5=368.5向下取整=>368
    368*0.5=184
    説明混沌追憶為另一個獨立區間


### 結論一
    由追加傷害得出的初步公式：
    縂傷害=追加傷害 * 增傷區間 * 刻印區間 * 混沌追憶區間
    增傷區間：爆傷，弱點，抗性
    刻印區間：刻印，免傷
    傷害區間相乘時先對當前傷害進行向下取整操作
    如果某個乘區為0或小於0時，則只能造成1的强制扣血

## 三、控制攻擊力和倍率推導boss防禦影響

### 數據展示
測試技能卡

![3-1.png](imgs/3/3-1.png)

關閉部分倍率相關熟練度方便計算

![3-2.png](imgs/3/3-2.png)

面板數據

![3-3.png](imgs/3/3-3.png)
### 測試結果
![3-4.png](imgs/3/3-4.png)

未突破防禦傷害組成：

    攻擊力3116
    倍率1120%+100%(來自熟練度)=1220%
    boss防禦50000
    追加傷害350
    强制扣血1
    斬弱50%
    MOD自帶增傷50%

得出如下：

    攻擊*倍率=3116*1220%=38015.2向下取整=>38015
    38015*(1+50%+50%)=76030
    (350+1)*(1+50%+50%)=702

可猜測防禦作用範圍：

猜想1：

    攻擊*倍率*增傷-防禦=76030-50000=26030
    如果是最終傷害減去防禦計算則會有26030左右傷害和追加傷害
    實際上只造成了追加傷害顯然不成立

猜想2：

    (攻擊*倍率-防禦)*增傷=38015-50000<0  =>造成强制扣血1
    縂傷害再加上追加傷害部分

### 對猜想2進行驗證
調整面板

![3-5.png](imgs/3/3-5.png)

武器攻擊力區間

![3-6.png](imgs/3/3-6.png)

    攻擊加成：
    7*5%+10%+15%=60%
    攻擊浮動值(665-578)*(1+60%)=139.2向下取整=>139
    攻擊浮動範圍5181~5320

多次測試

![3-7.png](imgs/3/3-7.png)

![3-8.png](imgs/3/3-8.png)

![3-9.png](imgs/3/3-9.png)

    突破防禦傷害組成：
    攻擊力5181~5320
    倍率1120%+100%=1220%
    boss防禦50000
    追加傷害350
    斬弱50%
    MOD自帶增傷50%
    得出如下：
    攻擊*倍率=63208~64904
    減去防禦得傷害13208~14904

    傷害範圍：
    [(13208+350)~(14904+350)]*(1+50%+50%)=27116~30508
    顯然三次測試傷害都落在該區間内


### 結論二
    加入防禦計算的傷害公式：

    基礎傷害=[(攻擊*倍率-防禦)+追加傷害]
    如果(攻擊*倍率-防禦)<0則置爲强制扣血1
    傷害加成=增傷區間*刻印區間*(1-混沌追憶)

    縂傷害=基礎傷害*傷害加成
    =[(攻擊*倍率-防禦)+追加傷害]*增傷區間*刻印區間*(1-混沌追憶)

## 四、覺醒率影響

### 數據展示
面板
![4-1.png](imgs/4/4-1.png)

### 初步測試
直接攻擊未破防禦
![4-2.png](imgs/4/4-2.png)

覺醒率40%，覺醒后攻擊
![4-3.png](imgs/4/4-3.png)

傷害組成：

    攻擊力2675
    倍率1120%+100%=1220%
    boss防禦50000
    追加傷害350
    斬弱50%
    MOD自帶增傷50%
    覺醒率40%
得出如下：

    攻擊*倍率=32635<50000
但是實際上造成傷害説明覺醒時無視防禦

若覺醒時完全無視防禦則

    造成(32635+350)* (1+50%+50%)*(1+40%)遠遠大於實際的26789

顯然不成立，説明覺醒只部分無視防禦。

猜測由於覺醒提升的部分傷害無視防禦，剩餘傷害會被怪物防禦影響。

則:

    總傷害=(1+350)*(1+50%+50%)+
    (32635+350)*(1+50%+50%)*40%=702+26388=27090
符合實際情況

覺醒時使用1.5倍刻印

發現并未對傷害進行提升
![4-4.png](imgs/4/4-4.png)
傷害組成：

    攻擊力2675
    倍率1120%+100%=1220%
    boss防禦50000
    追加傷害350
    斬弱50%
    MOD自帶增傷50%
    攻擊*倍率=32635<50000
初步猜測：

    縂傷害=[(攻擊*倍率-防禦)+追加傷害]*增傷區間*刻印區間+
    [攻擊*倍率+追加傷害]*增傷區間*覺醒率=
    (1+350)*(1+50%+50%)*(1+50%)+
    (32635+350)*(1+50%+50%)*40%=1053+26388=27441
根據以上結果把傷害組成分爲兩部分：

    普通傷害=[(攻擊*倍率-防禦)+追加傷害]*增傷區間*刻印區間
    覺醒傷害=[攻擊*倍率+追加傷害]*增傷區間*覺醒率
怪物防禦，刻印，免傷等僅對普通傷害進行作用，即覺醒部分傷害無視防禦，無視免傷


### 改變覺醒率多次驗證
30%覺醒率
![4-5.png](imgs/4/4-5.png)
傷害組成：

    攻擊力2675
    倍率1120%+100%=1220%
    boss防禦50000
    追加傷害350
    斬弱50%
    MOD自帶增傷50%
得出如下：

    總傷害=(1+350)*(1+50%+50%)+
    (32635+350)*(1+50%+50%)*30%=702+19791=20493

50%覺醒率
![4-6.png](imgs/4/4-6.png)
傷害組成：

    攻擊力2675
    倍率1120%+100%=1220%
    boss防禦50000
    追加傷害350
    斬弱50%
    MOD自帶增傷50%
得出如下：

    總傷害=(1+350)*(1+50%+50%)+
    (32635+350)*(1+50%+50%)*50%=702+32985=33687

### 結論三
    加入覺醒率計算的初步公式（覺醒情況下對無混沌追憶boss傷害）：
    普通傷害基礎傷害=[(攻擊*倍率-防禦)+追加傷害]
    普通傷害的傷害加成=增傷區間*刻印區間
    普通傷害=[(攻擊*倍率-防禦)+追加傷害]*增傷區間*刻印區間
    覺醒傷害基礎傷害=[攻擊*倍率+追加傷害]
    覺醒傷害的傷害加成=增傷區間*覺醒率
    覺醒傷害=[攻擊*倍率+追加傷害]*增傷區間*覺醒率
    縂傷害=普通傷害+覺醒傷害=
    [(攻擊*倍率-防禦)+追加傷害]*增傷區間*刻印區間+
    [攻擊*倍率+追加傷害]*增傷區間*覺醒率

## 五、混沌追憶作用
### 測試boss
### 詳細測試
## 六、最終公式和結論
